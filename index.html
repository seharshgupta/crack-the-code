<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>Crack the Code</title>
    <script src="/socket.io/socket.io.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; margin: 0; display: flex; justify-content: center; min-height: 100vh; }
        .container { background: white; margin-top: 30px; padding: 25px; width: 95%; max-width: 800px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); height: fit-content; margin-bottom: 50px; }
        .hidden { display: none !important; }
        
        h2 { text-align: center; margin-bottom: 25px; color: #333; }
        input, button { padding: 14px; font-size: 16px; border-radius: 8px; width: 100%; margin-bottom: 12px; box-sizing: border-box; border: 2px solid #ddd; outline: none; }
        input:focus { border-color: #007bff; }
        
        button { background: #007bff; color: white; font-weight: bold; border: none; cursor: pointer; transition: transform 0.1s; }
        button:active { transform: scale(0.98); }
        button.secondary { background: #6c757d; }
        button:disabled { background: #ccc; cursor: not-allowed; }

        .selection-grid { display: flex; gap: 15px; }
        .big-btn { height: 120px; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; flex-direction: column; }

        .player-list { list-style: none; padding: 0; margin: 20px 0; }
        .player-item { background: #f8f9fa; padding: 15px; margin-bottom: 8px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; border-left: 5px solid #007bff; font-weight: 500; }
        
        .info-bar { display: flex; justify-content: space-between; background: #343a40; color: white; padding: 12px 15px; border-radius: 8px; margin-bottom: 20px; font-size: 0.9rem; }
        .info-item b { display: block; font-size: 0.75rem; color: #adb5bd; text-transform: uppercase; }

        .turn-banner { padding: 12px; color: white; font-weight: bold; text-align: center; border-radius: 8px; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px; }
        .my-turn { background: #28a745; }
        .their-turn { background: #dc3545; }

        .game-board { display: flex; gap: 20px; }
        .panel { flex: 1; border: 1px solid #eee; border-radius: 12px; overflow: hidden; }
        .panel-head { background: #f8f9fa; padding: 12px; font-weight: bold; text-align: center; border-bottom: 1px solid #eee; }
        
        table { width: 100%; border-collapse: collapse; }
        td, th { padding: 10px; text-align: center; border-bottom: 1px solid #f1f1f1; font-size: 0.95rem; }
        
        /* Help Buttons */
        .help-btn { display: inline-block; width: 18px; height: 18px; background: #adb5bd; color: white; border-radius: 50%; text-align: center; line-height: 18px; font-size: 12px; margin-left: 6px; cursor: pointer; font-weight: bold; }
        .help-btn:hover { background: #6c757d; }
        .help-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1100; }
        .help-box { background: white; padding: 25px; border-radius: 12px; max-width: 300px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .help-box h3 { margin-top: 0; color: #007bff; }

        /* --- CHAT STYLES --- */
        .chat-container { margin-top: 30px; border-top: 2px solid #eee; padding-top: 20px; }
        .chat-window { height: 150px; overflow-y: auto; border: 1px solid #eee; border-radius: 8px; padding: 10px; background: #fafafa; margin-bottom: 10px; }
        .chat-msg { margin: 5px 0; font-size: 0.9rem; }
        .my-msg { color: #007bff; text-align: right; }
        .op-msg { color: #333; text-align: left; }
        .chat-input-area { display: flex; gap: 8px; }

        @media (max-width: 600px) {
            .game-board { flex-direction: column; }
            .selection-grid { flex-direction: column; }
            .info-bar { flex-direction: column; gap: 8px; text-align: center; }
        }

        #winOverlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .win-box { background: white; padding: 30px; border-radius: 16px; text-align: center; width: 80%; max-width: 300px; }
    </style>
</head>
<body>
    <div class="container">
        <h2 id="mainTitle">üîí Mastermind</h2>

        <div id="view-menu">
            <div class="selection-grid">
                <button class="big-btn" onclick="showCreate()"><span>‚ûï Create Room</span></button>
                <button class="big-btn secondary" onclick="showJoin()"><span>‚û° Join Room</span></button>
            </div>
        </div>

        <div id="view-create" class="hidden">
            <h3>Create a New Room</h3>
            <input id="createName" placeholder="Enter Your Name">
            <button onclick="doCreate()">Generate Room ID</button>
            <button class="secondary" onclick="goBack()">Back</button>
        </div>

        <div id="view-join" class="hidden">
            <h3>Join Existing Room</h3>
            <input id="joinName" placeholder="Enter Your Name">
            <input id="joinRoomId" type="number" placeholder="Enter 4-Digit Room ID">
            <button onclick="doJoin()">Join Lobby</button>
            <button class="secondary" onclick="goBack()">Back</button>
        </div>

        <div id="view-lobby" class="hidden">
            <div style="text-align: center;">
                <p style="color:#666; margin:0;">Room ID</p>
                <div id="lobbyRoomId" style="font-size: 3rem; font-weight: bold; color: #007bff; letter-spacing: 5px;">----</div>
                <p>Waiting for players...</p>
            </div>
            <ul id="lobbyList" class="player-list"></ul>
        </div>

        <div id="view-setup" class="hidden">
            <h3>Set Your Secret Code</h3>
            <p>Enter 4 unique digits.</p>
            <input id="secretInput" type="password" maxlength="4" placeholder="****" style="letter-spacing: 5px; text-align: center; font-size: 1.5rem;">
            <button onclick="setSecret()">Lock Secret üîí</button>
            <p id="setupMsg" style="text-align: center; color: #666;"></p>
        </div>

        <div id="view-game" class="hidden">
            <div class="info-bar">
                <div class="info-item"><b>Room</b> <span id="gameRoomDisplay"></span></div>
                <div class="info-item"><b>Player</b> <span id="gamePlayerDisplay"></span></div>
                <div class="info-item"><b>Secret</b> <span id="gameSecretDisplay">****</span></div>
            </div>

            <div id="turnBanner" class="turn-banner"></div>

            <div style="display: flex; gap:10px; margin-bottom: 20px;">
                <input id="guessInput" type="tel" maxlength="4" placeholder="Enter Guess">
                <button id="guessBtn" onclick="makeGuess()" style="width: auto; margin:0;">Submit</button>
            </div>

            <div class="game-board">
                <div class="panel">
                    <div class="panel-head">My Guesses</div>
                    <table id="myTable">
                        <thead><tr><th>Guess</th><th>Bulls <span class="help-btn" onclick="toggleHelp('bulls')">?</span></th><th>Cows <span class="help-btn" onclick="toggleHelp('cows')">?</span></th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="panel">
                    <div class="panel-head" id="opNameDisplay">Opponent</div>
                    <table id="opTable">
                        <thead><tr><th>Guess</th><th>Bulls <span class="help-btn" onclick="toggleHelp('bulls')">?</span></th><th>Cows <span class="help-btn" onclick="toggleHelp('cows')">?</span></th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div class="chat-container">
                <h4 style="margin-top:0; color:#555;">üí¨ Chat</h4>
                <div id="chatWindow" class="chat-window"></div>
                <div class="chat-input-area">
                    <input id="chatInput" placeholder="Type a message..." style="margin:0;">
                    <button onclick="sendChat()" style="width: auto; margin:0; padding: 0 20px;">Send</button>
                </div>
            </div>
        </div>
        
        <p id="errorDisplay" style="color: red; text-align: center; margin-top: 15px;"></p>
    </div>

    <div id="bullsHelpModal" class="help-overlay hidden" onclick="toggleHelp('bulls')">
        <div class="help-box" onclick="event.stopPropagation()">
            <h3>üéØ Bulls</h3><p>Correct digit in the <b>correct</b> position.</p><button onclick="toggleHelp('bulls')" style="width: auto;">Got it</button>
        </div>
    </div>
    <div id="cowsHelpModal" class="help-overlay hidden" onclick="toggleHelp('cows')">
        <div class="help-box" onclick="event.stopPropagation()">
            <h3>üêÆ Cows</h3><p>Correct digit in the <b>wrong</b> position.</p><button onclick="toggleHelp('cows')" style="width: auto;">Got it</button>
        </div>
    </div>
    <div id="winOverlay" class="hidden">
        <div class="win-box">
            <h1 id="winTitle" style="margin:0 0 10px 0;">VICTORY</h1>
            <p id="winMsg">You cracked the code!</p>
            <button onclick="location.reload()">Play Again</button>
        </div>
    </div>

    <script>
        const socket = io();
        let myName = "", myRoom = "", mySecret = "";

        const views = {
            menu: document.getElementById('view-menu'),
            create: document.getElementById('view-create'),
            join: document.getElementById('view-join'),
            lobby: document.getElementById('view-lobby'),
            setup: document.getElementById('view-setup'),
            game: document.getElementById('view-game')
        };
        const errDisplay = document.getElementById('errorDisplay');

        function toggleHelp(type) {
            document.getElementById(type === 'bulls' ? 'bullsHelpModal' : 'cowsHelpModal').classList.toggle('hidden');
        }

        function switchView(viewName) {
            errDisplay.innerText = "";
            Object.values(views).forEach(el => el.classList.add('hidden'));
            views[viewName].classList.remove('hidden');
        }

        function goBack() { switchView('menu'); }
        function showCreate() { switchView('create'); }
        function showJoin() { switchView('join'); }

        function doCreate() {
            const name = document.getElementById('createName').value.trim();
            if(!name) return showError("Name is required");
            myName = name;
            socket.emit('create_room', { name });
        }

        function doJoin() {
            const name = document.getElementById('joinName').value.trim();
            const roomId = document.getElementById('joinRoomId').value.trim();
            if(!name || !roomId) return showError("Name and Room ID required");
            myName = name;
            myRoom = roomId;
            socket.emit('join_room', { roomId, name });
        }

        function setSecret() {
            const secret = document.getElementById('secretInput').value;
            if(!/^\d{4}$/.test(secret) || new Set(secret).size !== 4) return showError("4 unique digits required");
            mySecret = secret;
            socket.emit('set_secret', { roomId: myRoom, secret });
            document.getElementById('setupMsg').innerText = "Secret Locked! Waiting for opponent...";
        }

        function makeGuess() {
            const g = document.getElementById('guessInput').value;
            if(!/^\d{4}$/.test(g)) return;
            socket.emit('make_guess', { roomId: myRoom, guess: g });
            document.getElementById('guessInput').value = "";
        }

        // --- CHAT FUNCTIONS ---
        function sendChat() {
            const input = document.getElementById('chatInput');
            const msg = input.value.trim();
            if(!msg) return;
            socket.emit('send_chat', { roomId: myRoom, message: msg, senderName: myName });
            input.value = "";
        }

        socket.on('receive_chat', (data) => {
            const chatWin = document.getElementById('chatWindow');
            const isMe = data.senderId === socket.id;
            const div = document.createElement('div');
            div.className = isMe ? 'chat-msg my-msg' : 'chat-msg op-msg';
            div.innerHTML = isMe ? data.message : `<b>${data.senderName}:</b> ${data.message}`;
            chatWin.appendChild(div);
            chatWin.scrollTop = chatWin.scrollHeight;
        });
        // ----------------------

        socket.on('room_created', ({ roomId }) => {
            myRoom = roomId;
            switchView('lobby');
            document.getElementById('lobbyRoomId').innerText = roomId;
        });

        socket.on('joined_success', ({ roomId }) => {
            myRoom = roomId;
            switchView('lobby');
            document.getElementById('lobbyRoomId').innerText = roomId;
        });

        socket.on('lobby_update', ({ players }) => {
            const list = document.getElementById('lobbyList');
            list.innerHTML = "";
            players.forEach(p => {
                const li = document.createElement('li');
                li.className = 'player-item';
                li.innerHTML = `<span>${p.name}</span> ${p.name === myName ? '(You)' : ''}`;
                list.appendChild(li);
            });
        });

        socket.on('move_to_setup', () => { switchView('setup'); });

        socket.on('game_ready', (data) => {
            switchView('game');
            document.getElementById('gameRoomDisplay').innerText = myRoom;
            document.getElementById('gamePlayerDisplay').innerText = myName;
            document.getElementById('gameSecretDisplay').innerText = mySecret;
            document.getElementById('opNameDisplay').innerText = data.opponent;
            updateTurn(data.turn);
        });

        socket.on('guess_result', (data) => {
            const isMe = data.player === socket.id;
            const tbody = document.querySelector(isMe ? '#myTable tbody' : '#opTable tbody');
            const row = `<tr><td>${data.guess}</td><td>${data.bulls}</td><td>${data.cows}</td></tr>`;
            tbody.innerHTML = row + tbody.innerHTML;

            if(data.winner) {
                document.getElementById('winOverlay').classList.remove('hidden');
                document.getElementById('winTitle').innerText = isMe ? "VICTORY üèÜ" : "DEFEAT üíÄ";
                document.getElementById('winMsg').innerText = isMe ? "You won!" : "Opponent won.";
            } else {
                updateTurn(data.nextTurn);
            }
        });

        function updateTurn(turnId) {
            const isMyTurn = turnId === socket.id;
            const banner = document.getElementById('turnBanner');
            const btn = document.getElementById('guessBtn');
            const input = document.getElementById('guessInput');
            banner.innerText = isMyTurn ? "üü¢ Your Turn" : "üî¥ Opponent's Turn";
            banner.className = `turn-banner ${isMyTurn ? 'my-turn' : 'their-turn'}`;
            btn.disabled = !isMyTurn;
            input.disabled = !isMyTurn;
        }

        socket.on('error_msg', showError);
        function showError(msg) { errDisplay.innerText = msg; }
    </script>
</body>
</html>