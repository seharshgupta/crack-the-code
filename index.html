<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>Crack the Code</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        :root { --primary: #007bff; --success: #28a745; --danger: #dc3545; --dark: #343a40; --light: #f8f9fa; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: #f0f2f5; margin: 0; display: flex; justify-content: center; min-height: 100vh; }
        .container { background: white; margin: 20px 0; padding: 25px; width: 95%; max-width: 850px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); height: fit-content; }
        .hidden { display: none !important; }
        
        h2 { text-align: center; color: var(--dark); margin-bottom: 25px; }
        input, button { padding: 14px; font-size: 16px; border-radius: 8px; width: 100%; margin-bottom: 12px; box-sizing: border-box; border: 2px solid #ddd; outline: none; }
        button { background: var(--primary); color: white; font-weight: bold; border: none; cursor: pointer; transition: 0.2s; }
        button:active { transform: scale(0.98); }
        button.secondary { background: #6c757d; }
        button.rejoin { background: var(--success); }
        button.invite { width: auto; padding: 8px 15px; font-size: 0.8rem; background: #6f42c1; margin: 0; }
        
        /* Game UI */
        .info-bar { display: flex; justify-content: space-between; align-items: center; background: var(--dark); color: white; padding: 12px 15px; border-radius: 8px; margin-bottom: 15px; font-size: 0.9rem; }
        .turn-banner { padding: 12px; color: white; font-weight: bold; text-align: center; border-radius: 8px; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px; }
        .my-turn { background: var(--success); }
        .their-turn { background: var(--danger); }

        .game-board { display: flex; gap: 20px; margin-top: 10px; }
        .panel { flex: 1; border: 1px solid #eee; border-radius: 12px; overflow: hidden; display: flex; flex-direction: column; }
        .panel-head { background: var(--light); padding: 12px; font-weight: bold; text-align: center; border-bottom: 1px solid #eee; }
        
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 10px; text-align: center; border-bottom: 1px solid var(--light); font-size: 0.9rem; }
        th { font-size: 0.75rem; color: #888; text-transform: uppercase; }

        .help-btn { display: inline-block; width: 18px; height: 18px; background: #ccc; color: white; border-radius: 50%; line-height: 18px; font-size: 12px; cursor: pointer; margin-left: 4px; }

        /* Chat */
        .chat-container { margin-top: 25px; border-top: 1px solid #eee; padding-top: 10px; }
        .chat-window { height: 140px; overflow-y: auto; border: 1px solid #fafafa; background: #fafafa; border-radius: 8px; padding: 10px; margin-bottom: 5px; }
        .chat-msg { margin: 4px 0; font-size: 0.9rem; }
        .my-msg { color: var(--primary); text-align: right; }
        #typingIndicator { font-size: 0.75rem; color: #888; height: 1rem; margin-left: 5px; margin-bottom: 5px; font-style: italic; }

        @media (max-width: 650px) {
            .game-board { flex-direction: column; }
            .info-bar { flex-direction: column; gap: 10px; text-align: center; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>üîí Crack the Code</h2>

        <div id="view-menu">
            <button onclick="switchView('create')">‚ûï Create Room</button>
            <button class="secondary" onclick="switchView('join')">‚û° Join Room</button>
            <button id="rejoinBtn" class="rejoin hidden" onclick="doRejoin()">üîÑ Rejoin Room</button>
        </div>

        <div id="view-create" class="hidden">
            <input id="createName" placeholder="Your Name">
            <button onclick="doCreate()">Generate Room ID</button>
            <button class="secondary" onclick="switchView('menu')">Back</button>
        </div>

        <div id="view-join" class="hidden">
            <input id="joinName" placeholder="Your Name">
            <input id="joinRoomId" type="number" placeholder="4-Digit Room ID">
            <button onclick="doJoin()">Join Room</button>
            <button class="secondary" onclick="switchView('menu')">Back</button>
        </div>

        <div id="view-lobby" class="hidden">
            <div style="text-align: center;">
                <p style="margin:0; color:#888">Room ID</p>
                <div id="lobbyRoomId" style="font-size: 3rem; font-weight: bold; color: var(--primary); letter-spacing: 4px;">----</div>
                <button class="invite" onclick="copyInvite()">üîó Copy Invite</button>
                <ul id="lobbyList" style="list-style:none; padding:20px 0; margin:0"></ul>
            </div>
        </div>

        <div id="view-setup" class="hidden">
            <h3 id="welcome" style="text-align:center"></h3>
            <input id="secretInput" type="tel" maxlength="4" placeholder="Enter 4 unique digits" style="text-align:center; letter-spacing:4px; font-size: 1.5rem;">
            <button onclick="setSecret()">Lock Secret üîí</button>
            <p id="setupMsg" style="text-align:center; color:#888"></p>
        </div>

        <div id="view-game" class="hidden">
            <div class="info-bar">
                <span>Room: <b id="gameRoomDisplay"></b> <button class="invite" style="font-size: 10px; padding:2px 5px" onclick="copyInvite()">Copy</button></span>
                <span>Secret: <b id="gameSecretDisplay">****</b></span>
            </div>
            <div id="turnBanner" class="turn-banner"></div>

            <div style="display:flex; gap:10px">
                <input id="guessInput" maxlength="4" type="tel" placeholder="Guess">
                <button id="guessBtn" onclick="makeGuess()" style="width:100px; margin:0">Submit</button>
            </div>

            <div class="game-board">
                <div class="panel">
                    <div class="panel-head">My Guesses</div>
                    <table>
                        <thead><tr><th>Guess</th><th>Bulls<span class="help-btn" onclick="toggleHelp('bulls')">?</span></th><th>Cows<span class="help-btn" onclick="toggleHelp('cows')">?</span></th></tr></thead>
                        <tbody id="myTable"></tbody>
                    </table>
                </div>
                <div class="panel">
                    <div class="panel-head" id="opNameDisplay">Opponent</div>
                    <table>
                        <thead><tr><th>Guess</th><th>Bulls<span class="help-btn" onclick="toggleHelp('bulls')">?</span></th><th>Cows<span class="help-btn" onclick="toggleHelp('cows')">?</span></th></tr></thead>
                        <tbody id="opTable"></tbody>
                    </table>
                </div>
            </div>

            <div class="chat-container">
                <div id="typingIndicator"></div>
                <div class="chat-window" id="chatWindow"></div>
                <div style="display:flex; gap:8px">
                    <input id="chatInput" placeholder="Message..." style="margin:0">
                    <button onclick="sendChat()" style="width:80px; margin:0">Send</button>
                </div>
            </div>
        </div>

        <p id="errorDisplay" style="color:var(--danger); text-align:center; font-weight:500; margin-top:15px"></p>
    </div>

    <div id="disconnectOverlay" class="hidden" style="position:fixed; inset:0; background:rgba(0,0,0,0.95); display:flex; justify-content:center; align-items:center; z-index:4000;">
        <div style="background:white; padding:40px; border-radius:20px; text-align:center; width:80%; max-width:400px; border: 4px solid var(--danger);">
            <h1 style="color:var(--danger); margin:0">‚ö†Ô∏è ALERT</h1>
            <p id="disconnectMsg" style="font-size: 1.2rem; margin: 20px 0; font-weight: bold;"></p>
            <p>Room will close in <b id="countdownText" style="font-size: 2rem; display:block; margin-top:10px;">60</b></p>
            <p style="color:#666; font-size:0.9rem">Please wait for them to reconnect.</p>
        </div>
    </div>

    <div id="bullsHelpModal" class="hidden" style="position:fixed; inset:0; background:rgba(0,0,0,0.5); display:flex; justify-content:center; align-items:center; z-index:2000;" onclick="toggleHelp('bulls')">
        <div style="background:white; padding:25px; border-radius:12px; max-width:300px; text-align:center">
            <h3>üéØ Bulls</h3><p>Correct digit in the <b>correct</b> position.</p><button style="width:auto">Got it</button>
        </div>
    </div>
    <div id="cowsHelpModal" class="hidden" style="position:fixed; inset:0; background:rgba(0,0,0,0.5); display:flex; justify-content:center; align-items:center; z-index:2000;" onclick="toggleHelp('cows')">
        <div style="background:white; padding:25px; border-radius:12px; max-width:300px; text-align:center">
            <h3>üêÆ Cows</h3><p>Correct digit in the <b>wrong</b> position.</p><button style="width:auto">Got it</button>
        </div>
    </div>

    <div id="winOverlay" class="hidden" style="position:fixed; inset:0; background:rgba(0,0,0,0.9); display:flex; justify-content:center; align-items:center; z-index:3000;">
        <div style="background:white; padding:40px; border-radius:20px; text-align:center; width:80%; max-width:350px;">
            <h1 id="winTitle" style="margin:0"></h1>
            <p id="winMsg" style="margin:20px 0; color:#666"></p>
            <button onclick="requestRematch()" style="background: var(--success); margin-bottom: 10px;">üîÑ New Game (Rematch)</button>
            <button onclick="exitRoom()" class="secondary">üö™ Exit Room</button>
        </div>
    </div>

    <script>
        const socket = io({ reconnection: true, reconnectionAttempts: 10, timeout: 20000 });
        let myName = "", myRoom = "", mySecret = "";
        
        const views = { menu: document.getElementById('view-menu'), create: document.getElementById('view-create'), join: document.getElementById('view-join'), lobby: document.getElementById('view-lobby'), setup: document.getElementById('view-setup'), game: document.getElementById('view-game') };

        // --- INIT & UTILS ---
        window.onload = () => {
            const r = localStorage.getItem('lastRoom'), p = localStorage.getItem('lastPlayer');
            if(r && p) { rejoinBtn.classList.remove('hidden'); rejoinBtn.innerText = `üîÑ Rejoin Room ${r}`; }
        };

        function switchView(v) { Object.values(views).forEach(el => el.classList.add('hidden')); views[v].classList.remove('hidden'); errorDisplay.innerText = ""; }
        function saveSession(r, n) { localStorage.setItem('lastRoom', r); localStorage.setItem('lastPlayer', n); }
        function toggleHelp(t) { document.getElementById(t==='bulls'?'bullsHelpModal':'cowsHelpModal').classList.toggle('hidden'); }
        function copyInvite() {
            const text = `Join my Crack the Code game!\nRoom ID: ${myRoom}\nLink: ${window.location.origin}`;
            navigator.clipboard.writeText(text).then(() => alert("Invite Copied!"));
        }

        // --- ACTIONS ---
        function doCreate() { myName = createName.value.trim(); if(myName) socket.emit('create_room', { name: myName }); }
        function doJoin() { myName = joinName.value.trim(); myRoom = joinRoomId.value.trim(); if(myName && myRoom) socket.emit('join_room', { roomId: myRoom, name: myName }); }
        function doRejoin() { myRoom = localStorage.getItem('lastRoom'); myName = localStorage.getItem('lastPlayer'); socket.emit('rejoin_room', { roomId: myRoom, name: myName }); }
        
        function setSecret() { 
            mySecret = secretInput.value; 
            // Changed input type to 'tel', so validation ensures 4 digits
            if(/^\d{4}$/.test(mySecret) && new Set(mySecret).size === 4) {
                socket.emit('set_secret', { roomId: myRoom, secret: mySecret }); 
            } else {
                alert("Please enter 4 UNIQUE digits.");
            }
        }
        
        function sendChat() { const m = chatInput.value.trim(); if(m) { socket.emit('send_chat', { roomId: myRoom, message: m, senderName: myName }); chatInput.value = ""; } }

        function makeGuess() { 
            const g = guessInput.value; 
            if(!/^\d{4}$/.test(g)) return;
            
            // --- CHANGED: Alert on Duplicate Guess ---
            const prev = Array.from(document.querySelectorAll('#myTable td:first-child')).map(td => td.innerText);
            if(prev.includes(g)) { 
                alert(`‚ö†Ô∏è You have already guessed ${g}! Try a different number.`);
                return; 
            }
            
            socket.emit('make_guess', { roomId: myRoom, guess: g }); 
            guessInput.value = ""; 
        }

        function requestRematch() { winOverlay.classList.add('hidden'); socket.emit('play_again', { roomId: myRoom }); }
        function exitRoom() { localStorage.removeItem('lastRoom'); localStorage.removeItem('lastPlayer'); socket.emit('leave_room', { roomId: myRoom }); }

        // --- TYPING INDICATOR ---
        let typingTimeout;
        chatInput.addEventListener('input', () => {
            socket.emit('typing', { roomId: myRoom, isTyping: true, name: myName });
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => socket.emit('typing', { roomId: myRoom, isTyping: false, name: myName }), 2000);
        });

        // --- SOCKET EVENTS ---
        socket.on('room_created', d => { myRoom = d.roomId; saveSession(myRoom, myName); switchView('lobby'); lobbyRoomId.innerText = d.roomId; });
        socket.on('joined_success', d => { myRoom = d.roomId; saveSession(myRoom, myName); switchView('lobby'); lobbyRoomId.innerText = d.roomId; });
        socket.on('lobby_update', d => { lobbyList.innerHTML = d.players.map(p => `<li style="padding:10px; background:#f8f9fa; margin:5px 0; border-radius:8px"><b>${p.name}</b> ${p.name===myName?'(You)':''}</li>`).join(''); });
        
        socket.on('move_to_setup', () => { 
            document.getElementById('myTable').innerHTML = ""; 
            document.getElementById('opTable').innerHTML = "";
            switchView('setup'); 
            welcome.innerText = `Hi, ${myName}`; 
        });

        socket.on('game_ready', d => { switchView('game'); gameRoomDisplay.innerText = myRoom; gameSecretDisplay.innerText = mySecret; opNameDisplay.innerText = d.opponent; updateTurn(d.turn); });

        socket.on('guess_result', d => {
            const isMe = d.playerName === myName;
            const row = `<tr><td><b>${d.guess}</b></td><td style="color:var(--success)">${d.bulls}</td><td style="color:#fd7e14">${d.cows}</td></tr>`;
            document.getElementById(isMe ? 'myTable' : 'opTable').innerHTML = row + document.getElementById(isMe ? 'myTable' : 'opTable').innerHTML;
            if(d.winner) { 
                winOverlay.classList.remove('hidden'); 
                winTitle.innerText = isMe ? "VICTORY üèÜ" : "DEFEAT üíÄ"; 
                winMsg.innerText = isMe ? "You cracked the code!" : `${d.playerName} cracked your code.`; 
            } else updateTurn(d.nextTurn);
        });

        socket.on('receive_chat', d => {
            const isMe = d.senderName === myName;
            chatWindow.innerHTML += `<div class="chat-msg ${isMe?'my-msg':''}"><b>${isMe?'You':d.senderName}:</b> ${d.message}</div>`;
            chatWindow.scrollTo(0, chatWindow.scrollHeight);
        });

        socket.on('display_typing', d => { typingIndicator.innerText = d.isTyping ? `${d.name} is typing...` : ""; });

        // --- REJOIN & SYNC ---
        socket.on('rejoined_game', d => {
            myRoom = d.roomId; myName = d.name; mySecret = d.secret;
            if(!d.started) return switchView('setup');
            
            switchView('game');
            gameRoomDisplay.innerText = myRoom; gameSecretDisplay.innerText = mySecret; opNameDisplay.innerText = d.opponentName;
            
            // Restore Chat
            chatWindow.innerHTML = d.chatHistory.map(m => `<div class="chat-msg ${m.senderName===myName?'my-msg':''}"><b>${m.senderName===myName?'You':m.senderName}:</b> ${m.message}</div>`).join('');
            
            // Restore Tables
            document.getElementById('myTable').innerHTML = ""; document.getElementById('opTable').innerHTML = "";
            d.guesses.forEach(g => {
                const isMe = g.playerName === myName;
                const row = `<tr><td><b>${g.guess}</b></td><td style="color:var(--success)">${g.bulls}</td><td style="color:#fd7e14">${g.cows}</td></tr>`;
                document.getElementById(isMe ? 'myTable' : 'opTable').innerHTML = row + document.getElementById(isMe ? 'myTable' : 'opTable').innerHTML;
            });
            updateTurn(d.turn);
            
            // CHANGED: Hide disconnect overlay if rejoining
            disconnectOverlay.classList.add('hidden');
        });

        socket.on('reset_for_rematch', () => {
            document.getElementById('myTable').innerHTML = "";
            document.getElementById('opTable').innerHTML = "";
            guessInput.value = "";
            switchView('setup');
            setupMsg.innerText = "New game! Set your new secret code.";
            winOverlay.classList.add('hidden');
        });

        socket.on('room_exited', () => { location.reload(); });
        
        // --- CHANGED: Alert Overlay Logic ---
        socket.on('opponent_disconnected', d => { 
            disconnectOverlay.classList.remove('hidden'); 
            disconnectMsg.innerText = `${d.name} has disconnected.`; 
            countdownText.innerText = d.timeLeft; 
        });
        
        socket.on('timer_tick', d => { countdownText.innerText = d.timeLeft; });
        
        socket.on('reconnect_success', m => { 
            // Automatically remove the alert overlay
            disconnectOverlay.classList.add('hidden'); 
            errorDisplay.innerText = m; 
            setTimeout(()=>errorDisplay.innerText="", 3000); 
        });
        
        socket.on('error_msg', m => showError(m));

        function updateTurn(id) {
            const isMy = id === socket.id;
            turnBanner.innerText = isMy ? "üü¢ Your Turn" : "üî¥ Opponent's Turn";
            turnBanner.className = `turn-banner ${isMy?'my-turn':'their-turn'}`;
            guessBtn.disabled = !isMy; guessInput.disabled = !isMy;
        }

        function showError(msg) { errorDisplay.innerText = msg; setTimeout(() => errorDisplay.innerText="", 3000); }
    </script>
</body>
</html>